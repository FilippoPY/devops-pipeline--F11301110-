name: CI Dev Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # 1️⃣ BUILD
  build:
    name: Build artifact
    runs-on: ubuntu-latest
    outputs:
      build_tag: ${{ steps.meta.outputs.build_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Build (generate artifact)
        run: |
          echo "🏗️ Building project..."
          mkdir -p dist
          echo "Build generado el $(date)" > dist/app.txt
          zip -r build.zip dist/

      - name: Define metadata
        id: meta
        run: |
          TAG="build-$(date +%s)"
          echo "build_tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Generated tag: $TAG"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: build.zip

  # 2️⃣ UNIT TESTS
  test-unit:
    name: Run Unit Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pytest
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Create fallback unit test
        run: |
          mkdir -p tests/unit
          echo "def add(a,b): return a+b" > tests/unit/test_basic.py
          echo "def test_add(): assert add(2,3)==5" >> tests/unit/test_basic.py
          echo "print('✅ Unit test de ejemplo creado correctamente.')" >> tests/unit/test_basic.py

      - name: Run Unit Tests
        env:
          TEST_ENV: unit
        run: |
          echo "🧪 Running UNIT tests ($TEST_ENV)"
          pytest -q tests/unit || (echo "❌ Unit tests failed" && exit 1)

  # 3️⃣ INTEGRATION TESTS
  test-integration:
    name: Run Integration Tests
    needs: test-unit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact
      - run: unzip -o build.zip

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pytest
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Create fallback integration test
        run: |
          mkdir -p tests/integration
          echo "import os" > tests/integration/test_artifact.py
          echo "def test_artifact_exists():" >> tests/integration/test_artifact.py
          echo "    exists = os.path.exists('dist/app.txt') or os.path.exists('./build/dist/app.txt')" >> tests/integration/test_artifact.py
          echo "    assert exists, '❌ dist/app.txt no existe en el build artifact'" >> tests/integration/test_artifact.py
          echo "print('✅ Integration test creado correctamente.')" >> tests/integration/test_artifact.py

      - name: Run Integration Tests
        env:
          TEST_ENV: integration
        run: |
          echo "🔗 Running INTEGRATION tests ($TEST_ENV)"
          pytest -q tests/integration || (echo "❌ Integration tests failed" && exit 1)

  # 4️⃣ DEPLOY STAGING
  deploy-staging:
    name: Deploy to Staging
    needs: test-integration
    runs-on: ubuntu-latest
    environment: staging
    outputs:
      staging_tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Compute metadata
        id: meta
        run: |
          TAG="staging-$(date +%s)"
          NOTE="Staging release after passing all tests"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "note=$NOTE" >> "$GITHUB_OUTPUT"
          echo "✅ Generated staging tag: $TAG"

      - name: Release to Staging
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "🚀 Deploying to staging environment..."
          gh release create "${{ steps.meta.outputs.tag }}" build.zip --notes "${{ steps.meta.outputs.note }}" --prerelease

  # 5️⃣ DEPLOY PRODUCTION (manual approval)
  deploy-production:
    name: Deploy to Production
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Compute metadata
        id: meta
        run: |
          TAG="prod-$(date +%s)"
          NOTE="Production release after manual approval"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "note=$NOTE" >> "$GITHUB_OUTPUT"
          echo "✅ Generated production tag: $TAG"

      - name: Release to Production
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "🚀 Deploying to production..."
          gh release create "${{ steps.meta.outputs.tag }}" build.zip --notes "${{ steps.meta.outputs.note }}"
